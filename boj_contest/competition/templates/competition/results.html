<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>경쟁 결과</title>
    <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist@2.21.0/plotly.min.js"></script>
</head>
<body>
    <h1></h1>

    <!-- 결과 테이블 -->
    <table>
        <thead>
            <tr>
                <th>Rank</th>
                <th>User ID</th>
                <th>Solved Problems</th>
                <th>Total Score</th>
            </tr>
        </thead>
        <tbody>
            {% for result in results %}
            <tr>
                <td>{{ result.rank }}</td>
                <td>{{ result.user_id__user__username }}</td>
                <td>{{ result.solved_count }}</td>
                <td>{{ result.total_score }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- 피드로 돌아가기 링크 -->
    <a href="{% url 'feed:index' %}">피드로 돌아가기</a>

    <!-- 그래프가 포함된 부분 -->
    <div id="chart" style="width: 100%; height: 500px;"></div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            fetch('{% url "competition:results" %}', {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                const traces = [];

                Object.keys(data.results).forEach((user, index) => {
                    const userData = data.results[user];
                    
                    const trace = {
                        x: userData.times.map(time => new Date(time)),
                        y: userData.scores,
                        mode: 'lines+markers',
                        type: 'scatter',
                        name: user,
                        line: { color: `hsl(${index * 60}, 70%, 50%)` }
                    };
                    
                    traces.push(trace);
                });

                const layout = {
                    title: '경쟁 결과',
                    xaxis: {
                        title: 'Time',
                        type: 'date'
                    },
                    yaxis: {
                        title: 'Score'
                    }
                };

                Plotly.newPlot('chart', traces, layout);
            })
            .catch(error => console.error('Error fetching data:', error));
        });
    </script>
</body>
</html>
